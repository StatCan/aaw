
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Developer Docs">
      
      
      
        <link rel="canonical" href="https://statcan.github.io/aaw/en/Aaw%20Contrib%20Containers/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.6">
    
    
      
        <title>Containers for DAaaS - AAW Dev Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="yellow" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#containers-for-daaas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AAW Dev Docs" class="md-header__button md-logo" aria-label="AAW Dev Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AAW Dev Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Containers for DAaaS
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/StatCan/aaw" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    StatCan/aaw
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AAW Dev Docs" class="md-nav__button md-logo" aria-label="AAW Dev Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    AAW Dev Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/StatCan/aaw" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    StatCan/aaw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Features
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Object Storage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Object Storage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/object-storage/s3proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    S3Proxy and S3 Explorer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/object-storage/blobcsi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blob CSI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/cloud-main-connectivity/cloud-main-connectivity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Main Connectivity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/data-virtualization/trino/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Virtualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_6" >
        
          
          <label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RBAC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_6">
            <span class="md-nav__icon md-icon"></span>
            RBAC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/rbac/non-employee-rbac/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Non-Employee RBAC
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/source-control/gitea/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Source Control
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Resources
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../developer-tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Networking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker-basics-and-good-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Basics and Good Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Docker Basics and Good Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-from-a-minimal-official-docker-image" class="md-nav__link">
    <span class="md-ellipsis">
      Start from a minimal official docker image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-your-containers-for-vulnerabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Scan your containers for vulnerabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-stanzas-from-least-likely-to-change-to-most-likely-to-change" class="md-nav__link">
    <span class="md-ellipsis">
      Order stanzas from least likely to change to most likely to change
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-python-packages-in-dockerfiles" class="md-nav__link">
    <span class="md-ellipsis">
      Handling python packages in Dockerfiles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do-setup-execute-and-cleanup-in-a-single-stanza" class="md-nav__link">
    <span class="md-ellipsis">
      Do setup, execute, and cleanup in a single stanza
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-containers-as-non-root-user" class="md-nav__link">
    <span class="md-ellipsis">
      Execute containers as non-root user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do-a-multi-stage-build" class="md-nav__link">
    <span class="md-ellipsis">
      Do a multi-stage build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-cache-busting-your-dockerfiles" class="md-nav__link">
    <span class="md-ellipsis">
      Avoid cache-busting your Dockerfiles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-build-time-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Set build-time variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lint-your-dockerfile" class="md-nav__link">
    <span class="md-ellipsis">
      Lint your Dockerfile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understand-when-not-to-use-alpine-based-images" class="md-nav__link">
    <span class="md-ellipsis">
      Understand when not to use Alpine-based images
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="containers-for-daaas">Containers for DAaaS<a class="headerlink" href="#containers-for-daaas" title="Permanent link">&para;</a></h1>
<p>Containers to be used for general purpose Data Science.</p>
<h2 id="docker-basics-and-good-practices">Docker Basics and Good Practices<a class="headerlink" href="#docker-basics-and-good-practices" title="Permanent link">&para;</a></h2>
<blockquote>
<p>The information below covers some recommended good practices with Docker and
provides some links for further reading.</p>
</blockquote>
<p><strong>Useful References and Background Reading:</strong></p>
<ul>
<li><a href="https://pythonspeed.com/products/productionhandbook/">Python on Docker Handbook</a></li>
<li><a href="https://www.amazon.ca/Container-Security-Fundamental-Containerized-Applications/dp/1492056707">Container Security Fundamentals Book</a></li>
</ul>
<h3 id="start-from-a-minimal-official-docker-image">Start from a minimal official docker image<a class="headerlink" href="#start-from-a-minimal-official-docker-image" title="Permanent link">&para;</a></h3>
<ul>
<li>Dockerhub has <a href="https://docs.docker.com/docker-hub/official_images/">official images</a> that are maintained by
  the Docker community (e.g. security updates happen in a timely manner).</li>
</ul>
<ul>
<li>An <a href="https://hub.docker.com/search?type=image&amp;category=base&amp;image_filter=official">official base image</a> is usually a great starting
  point to build off of.</li>
</ul>
<ul>
<li>Many custom images only slightly extend a common base image (e.g. <a href="https://gitlab.com/nvidia/container-images/cuda/-/blob/master/dist/11.1.1/ubuntu20.04-x86_64/base/Dockerfile">Nvidia's
  base images</a> are slight extensions of the ubuntu official
  base image)</li>
</ul>
<p><strong>Recommendation:</strong> start from a small official base image and build layers
ontop of it.</p>
<p><strong>Example steps to add a new image to aaw-contrib-containers</strong>
1. Scan image using a tool like Trivy <code>$ ./trivy image hub.docker.com/yourdockerimage:latest (*best practice*)</code>
2. Create new branch of StatCan/aaw-contrib-contains
3. Commit docker file and publish new branch
4. Allow repo CI, ACR and Artifactory scan to complete
5. Create pull request (ping us in our Slack space https://statcan-aaw.slack.com <strong>#general</strong>)</p>
<h3 id="scan-your-containers-for-vulnerabilities">Scan your containers for vulnerabilities<a class="headerlink" href="#scan-your-containers-for-vulnerabilities" title="Permanent link">&para;</a></h3>
<ul>
<li>There are lots of tools to do this in an automated way (e.g. <a href="https://github.com/aquasecurity/trivy">trivy</a>)</li>
</ul>
<ul>
<li>Can build a docker image and scan it as part of a continuous integration
  pipeline. E.g. a condition to merge to master is that the Dockerfile provided
  must build successfully and then pass a security scan.</li>
</ul>
<p><strong>Recommendation:</strong> scan images for vulnerabilities, and consider incorporating
this process as a job in your CI/CD pipeline.</p>
<h3 id="order-stanzas-from-least-likely-to-change-to-most-likely-to-change">Order stanzas from least likely to change to most likely to change<a class="headerlink" href="#order-stanzas-from-least-likely-to-change-to-most-likely-to-change" title="Permanent link">&para;</a></h3>
<ul>
<li>Each line in your <code>Dockerfile</code> is called a stanza.</li>
</ul>
<ul>
<li>When you are building an image, Docker is creating and caching an image layer
  for each stanza in your <code>Dockerfile</code>. Since layers are cached, if you build
  your image multiple times (e.g. you are changing certain stanzas), Docker can
  reuse the cached layers to reduce build time.</li>
</ul>
<ul>
<li>However, any stanzas that come after the changed stanza <strong>will be rebuilt</strong>
  and therefore do not benefit from this layer caching that Docker implements.</li>
</ul>
<p><strong>Recommendation:</strong> to take advantage of layer caching and reduce your image
build times, it is recommended to put expensive stanzas that don't change often
early in your Dockerfile, and put lighter stanzas that do change often at the
end. This allows you to avoid rebuilding expensive unchanging layers every time
you need to rebuild your image after making a small change (e.g. installing a
new Python package).</p>
<h3 id="handling-python-packages-in-dockerfiles">Handling python packages in Dockerfiles<a class="headerlink" href="#handling-python-packages-in-dockerfiles" title="Permanent link">&para;</a></h3>
<ul>
<li>In general it is good practice to use a <code>requirements.txt</code> file in a project and to pin the versions (<code>pandas==1.2.3</code> rather than just <code>pandas</code>). Requirements files are also useful in constructing more succinct Dockerfiles (<code>RUN pip install -r requirements.txt</code> is briefer than <code>RUN pip install package1 package2 ...</code>)</li>
</ul>
<ul>
<li>But, sometimes <code>requirements.txt</code> files can cause issues in Dockerfiles. For example, if you have 10 packages that never change but one that is updated frequently, you have the same problem as when you put frequently changed items at the top of a Dockerfile. Sometimes it is appropriate to have <code>requirements_rarely_changing.txt</code> and <code>requirements_frequently_changing.txt</code> (or, perhaps better titles), this way the frequently changing packages can be installed later in the Dockerfile.</li>
</ul>
<h3 id="do-setup-execute-and-cleanup-in-a-single-stanza">Do setup, execute, and cleanup in a single stanza<a class="headerlink" href="#do-setup-execute-and-cleanup-in-a-single-stanza" title="Permanent link">&para;</a></h3>
<ul>
<li>As mentioned above, docker creates image layers based on a single stanza.</li>
</ul>
<ul>
<li>If you do these steps in 3 separate stanzas, you will create 3 different
  layers that will all be stacked on your image. This can lead to Docker images
  that take up a lot more space on disk than they need to.</li>
</ul>
<p><strong>Good Example:</strong></p>
<div class="language-docker highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</span></code></pre></div>
<p><strong>Bad Example:</strong></p>
<div class="language-docker highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>update
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>git
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">RUN</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</span></code></pre></div>
<p><strong>Recommendation:</strong> Keep your setup, execute, and cleanup work in a single
stanza so that an image layer of minimal size gets created instead of multiple
larger layers.</p>
<h3 id="execute-containers-as-non-root-user">Execute containers as non-<code>root</code> user<a class="headerlink" href="#execute-containers-as-non-root-user" title="Permanent link">&para;</a></h3>
<ul>
<li>If the base image doesn't have one, <a href="https://github.com/StatCan/daaas-containers/blob/99e1fad4755e8d31990f074afa7ea084150c071a/frontier-counts/Dockerfile#L1-L10">add a non-root user to your
  container</a>. <strong>Don't forget to <a href="https://github.com/StatCan/daaas-containers/blob/99e1fad4755e8d31990f074afa7ea084150c071a/frontier-counts/Dockerfile#L23">set <code>USER</code> at the
  end</a>.</strong></li>
</ul>
<ul>
<li>By default, many containers are configured to run as root user.</li>
</ul>
<ul>
<li>This is necessary at build time because we often need to install packages and
  change configuration settings.</li>
</ul>
<ul>
<li>When it's time to run the container, however, we should run it as a non-root
  user (i.e. a less privileged user) by default.</li>
</ul>
<ul>
<li>Reason for the above is that containers only provide process level
  virtualization as opposed to true operating system level virtualization. With
  a virtual machine manager such as VMWare, running as root on the VM doesn't
  give you access to the host machine. In a container runtime like Docker,
  however, your container is just a special kind of process on the host machine
  (spawned from the Docker Daemon on the host). This means it is possible for a
  malicious container to run as a process with root privileges on the host
  machine if the container itself is executed as root.</li>
</ul>
<ul>
<li>Docker provides the <code>USER</code> directive to change the active user (can create a
  user using the <code>adduser</code> command in linux, see code snippet above).</li>
</ul>
<p><strong>Recommendation:</strong> always set the user to a non-root user at the end of your
Dockerfile by default using the <code>USER</code> directive in your Dockerfile.</p>
<h3 id="do-a-multi-stage-build">Do a multi-stage build<a class="headerlink" href="#do-a-multi-stage-build" title="Permanent link">&para;</a></h3>
<p>There are a couple of key reasons to building an image in this way.</p>
<ul>
<li>Reduced disk footprint - you can use one image to build one or more artifacts,
  then simply copy the relevant build artifact(s) out of the first image into a
  second image.</li>
</ul>
<ul>
<li>Improved Security - You can use a complete image to build your application,
  then copy your application into a <a href="https://github.com/GoogleContainerTools/distroless">distroless</a> image.<ul>
<li>A distroless image is a very stripped down image that contains only your
  applications and its runtime dependencies (e.g. a Python image might contain
  a python interpreter in a virtual environment)</li>
<li>This implies that there are no shells, package managers, or other programs
  you would expect to find on a standard Linux distribution).</li>
<li>Improves security because there is much less attack surface area (i.e. there
  are fewer ways an attacker can perform a malicious act on a distroless
  image).</li>
</ul>
</li>
</ul>
<p><strong>Recommendation:</strong> consider using a multistage build to reduce disk footprint,
and, if applicable, consider copying your applications/build artifacts to a
distroless image to improve security.</p>
<h3 id="avoid-cache-busting-your-dockerfiles">Avoid cache-busting your Dockerfiles<a class="headerlink" href="#avoid-cache-busting-your-dockerfiles" title="Permanent link">&para;</a></h3>
<ul>
<li>Docker tries to avoid building anything it knows has not changed, but it cannot always detect this properly. When in situations where Docker always rebuilds layers unnecessarily, consider breaking your build into multiple images. This way you can put your static content in the first image, then base your final image on that first image (<code>FROM myfirstimage:v123</code>). This way you prevent Docker from trying to decide if your static content needs to be rebuilt (but note, if you do this and your static content does need rebuidling, you need to do that yourself!)</li>
</ul>
<ul>
<li>Sometimes with python packages Docker will misunderstand whether a <code>requirements.txt</code> has changed, forcing a full reinstall of your python packages even when they are cached. One way around this is to add <code>RUN pip install mySlowPackages==0.1.2</code> explicitly near the top of the Dockerfile <strong>in addition to in your requirements.txt file later in the build</strong>. The benefit of this is that those explicit calls to pip are easier for Docker to cache, so they won't be reinstalled as frequently. And even though you do <code>pip install -r requirements.txt</code> later, pip itself will see that your package is already installed and skip it, meaning you save almost as much time as if Docker got the cache correct.</li>
</ul>
<h3 id="set-build-time-variables">Set build-time variables<a class="headerlink" href="#set-build-time-variables" title="Permanent link">&para;</a></h3>
<ul>
<li>Docker provides an <code>ARG</code> directive that lets you specify build-time arguments.</li>
</ul>
<ul>
<li>These build-time arguments don't persist when you launch a container instance
  from the image (in contrast to the <code>ENV</code> directive that sets environment
  variables that persist once the image is built).</li>
</ul>
<ul>
<li>If you declare a build argument with <code>ARG</code>, you can pass
  <code>--build-arg ARG_NAME=some_value</code> when you run your <code>docker build</code> command to
  override whatever the default value of that argument is.</li>
</ul>
<ul>
<li>Example: your image build depends on specific versions of another package you
  want to install, to make the image reusable, you may want to pass the package
  version as a build argument so that you can build different versions of the
  image over time.</li>
</ul>
<ul>
<li>Example: you might want to set different build-time variables if you are
  building your image for different hosts (e.g. the URL for a proxy server).</li>
</ul>
<ul>
<li>See <a href="https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables-build-arg">documentation on Docker builds</a> for more information.</li>
</ul>
<p><strong>Recommendation:</strong> where applicable, consider using build-time arguments by
using <code>ARG</code> and <code>--build-arg</code> to declare and override build-time arguments.</p>
<h3 id="lint-your-dockerfile">Lint your Dockerfile<a class="headerlink" href="#lint-your-dockerfile" title="Permanent link">&para;</a></h3>
<ul>
<li>There is a tool called <a href="https://github.com/hadolint/hadolint">hadolint</a> that you can use to lint your Dockerfile.</li>
</ul>
<ul>
<li>The linter will indicate areas where you can improve your Dockerfile and also
  provide suggestions.</li>
</ul>
<p><strong>Recommendation:</strong> lint your Dockerfile to improve code quality.</p>
<h3 id="understand-when-not-to-use-alpine-based-images">Understand when not to use Alpine-based images<a class="headerlink" href="#understand-when-not-to-use-alpine-based-images" title="Permanent link">&para;</a></h3>
<ul>
<li>A popular minimal image that is used as a base image in the Docker community
  is the <a href="https://hub.docker.com/_/alpine">alpine</a> image, which is based off of the Alpine distribution of
  Linux.</li>
</ul>
<ul>
<li>This is a very lightweight image that has many use cases, but it may not be a good choice as a base image for data science oriented projects. In particular, for projects with heavy Python dependencies, it may be worth considering an alternative base image.</li>
</ul>
<ul>
<li>
<p>Why?</p>
<ul>
<li>Reason is that most python packages include prebuilt wheels (wheels are a kind of pre-built distribution for python that allow you to avoid the build stage that is normally required with source distributions).</li>
<li>Since Alpine is very stripped down compared to other Linux distributions, it has a different version of the standard C library that is required by most C programs (including Python). Specifically, the Alpine image uses the <a href="https://musl.libc.org/"><code>musl</code></a> implementation of the C standard library instead of <a href="https://www.gnu.org/software/libc/"><code>glibc</code></a> implementation.</li>
<li>Because of the above, Python wheels generally aren't available for <code>musl</code>, so when you install Python packages on an Alpine based image, you install the source code, which means that all C code in every Python package you use must be compiled.</li>
<li>This also means you need to figure out every system library dependency yourself.</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Bottom Line:</strong> If you try to install a bunch of Python packages on an Alpine based image, your build may take longer, be more error prone, and result in a higher disk footprint than if you installed those Python packages on an image based on Debian or another Linux distribution with the full standard C library (<code>glibc</code>).</li>
</ul>
<p><strong>Recommendation:</strong> Depending on your project requirements, if your project contains many Python dependencies, you may want to consider using a Docker image based on Debian or another Linux distribution other than Alpine. Note that this is not an absolute recommendation, as there are other considerations (e.g. security) that can impact the decision of which base image to use. However, you should be aware of the above-mentioned implication of using Alpine images for projects with significant Python dependencies.</p>
<p><strong>Background reading for those interested:</strong></p>
<ul>
<li>Article: <a href="https://realpython.com/python-wheels/">Python Wheels</a></li>
<li>Article: <a href="https://pythonspeed.com/articles/alpine-docker-python/">Alpine Docker with Python vs. Debian</a></li>
</ul>
<h1 id="link">Link<a class="headerlink" href="#link" title="Permanent link">&para;</a></h1>
<p><a href="https://github.com/StatCan/aaw-contrib-containers">aaw-contrib-containers</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 Statistics Canada
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/StatCan/aaw" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://statcan-aaw.slack.com" target="_blank" rel="noopener" title="statcan-aaw.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.e1c3ead8.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>